#!/bin/bash

AWS_DEFAULT_PROFILE="int-shs"

get_secret() {
  local secret_path=$1
  local key=$2

  echo $(aws secretsmanager get-secret-value \
    --secret-id "$secret_path" \
    --query 'SecretString' \
    --output text --profile $AWS_DEFAULT_PROFILE  |  jq -r ".$key")
}

aws configure set aws_access_key_id $(get_secret interos/gov/stg/iam/int-infra-ops-poweruser-deployer AWS_ACCESS_KEY_ID) --profile gov-stg
aws configure set aws_secret_access_key $(get_secret interos/gov/stg/iam/int-infra-ops-poweruser-deployer AWS_SECRET_ACCESS_KEY) --profile gov-stg
aws configure set aws_access_key_id $(get_secret interos/clz/gov/prd/iam/int-infra-ops-admin-gitlab-runner AWS_ACCESS_KEY_ID) --profile gov-prod
aws configure set aws_secret_access_key $(get_secret interos/clz/gov/prd/iam/int-infra-ops-admin-gitlab-runner AWS_SECRET_ACCESS_KEY) --profile gov-prod

GOV_STG_ECR_TOKEN=$(aws ecr get-login-password --region us-gov-west-1 --profile gov-stg)

echo ${GOV_STG_ECR_TOKEN} | docker  login --username AWS --password-stdin 378365008553.dkr.ecr.us-gov-west-1.amazonaws.com
echo ${GOV_STG_ECR_TOKEN} | skopeo  login --username AWS --password-stdin 378365008553.dkr.ecr.us-gov-west-1.amazonaws.com

GOV_PRD_ECR_TOKEN=$(aws ecr get-login-password --region us-gov-west-1 --profile gov-prod)

echo ${GOV_PRD_ECR_TOKEN} | docker  login --username AWS --password-stdin 407568541501.dkr.ecr.us-gov-west-1.amazonaws.com
echo ${GOV_PRD_ECR_TOKEN} | skopeo  login --username AWS --password-stdin 407568541501.dkr.ecr.us-gov-west-1.amazonaws.com
